<!DOCTYPE html>
<html lang="ja-jp">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>公式メトリックプラグインを導入する | Mackerel-Twilio HandsOn</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="This is the procedure page used in Mackerel Hands-On Seminar.">
    
    <link rel="preload" href="/mackerel-twilio-handson/assets/css/0.styles.53356f0a.css" as="style"><link rel="preload" href="/mackerel-twilio-handson/assets/js/app.e3b6fb0f.js" as="script"><link rel="preload" href="/mackerel-twilio-handson/assets/js/2.3f3f937c.js" as="script"><link rel="preload" href="/mackerel-twilio-handson/assets/js/12.818ed927.js" as="script"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/10.45633385.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/11.01a6b7a4.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/13.66233b91.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/14.3773edaa.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/15.be4a4cf5.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/3.f4f4ac45.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/4.17e7ea54.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/5.2bccf768.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/6.20f1e48a.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/7.bf28a1e7.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/8.c351cd62.js"><link rel="prefetch" href="/mackerel-twilio-handson/assets/js/9.ce20ef3b.js">
    <link rel="stylesheet" href="/mackerel-twilio-handson/assets/css/0.styles.53356f0a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mackerel-twilio-handson/" class="home-link router-link-active"><!----> <span class="site-name">Mackerel-Twilio HandsOn</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>目次</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mackerel-twilio-handson/" aria-current="page" class="sidebar-link">ハンズオン概要</a></li><li><a href="/mackerel-twilio-handson/01_signup/" class="sidebar-link">オーガニゼーションを作成する</a></li><li><a href="/mackerel-twilio-handson/02_install_agent/" class="sidebar-link">エージェントをインストールする</a></li><li><a href="/mackerel-twilio-handson/03_service_role/" class="sidebar-link">サービス／ロールでホスト管理をする</a></li><li><a href="/mackerel-twilio-handson/04_monitors/" class="sidebar-link">監視ルールを追加する</a></li><li><a href="/mackerel-twilio-handson/05_metric_plugins/" aria-current="page" class="active sidebar-link">公式メトリックプラグインを導入する</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mackerel-twilio-handson/05_metric_plugins/#公式プラグインをインストールする" class="sidebar-link">公式プラグインをインストールする</a></li><li class="sidebar-sub-header"><a href="/mackerel-twilio-handson/05_metric_plugins/#osに関するメトリックを拡張してみる" class="sidebar-link">OSに関するメトリックを拡張してみる</a></li></ul></li><li><a href="/mackerel-twilio-handson/06_check_plugins/" class="sidebar-link">公式チェックプラグインを導入する</a></li><li><a href="/mackerel-twilio-handson/07_notification/" class="sidebar-link">通知をカスタマイズする</a></li><li><a href="/mackerel-twilio-handson/08_twilio/" class="sidebar-link">Twilioと連携して架電通知をする</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="公式メトリックプラグインを導入する"><a href="#公式メトリックプラグインを導入する" class="header-anchor">#</a> 公式メトリックプラグインを導入する</h1> <p>監視対象ホストに公式メトリックプラグインをインストールしてOS、ミドルウェアの監視をしてみましょう。</p> <h2 id="公式プラグインをインストールする"><a href="#公式プラグインをインストールする" class="header-anchor">#</a> 公式プラグインをインストールする</h2> <p>監視対象サーバーで以下のコマンドを実行し、公式プラグインをインストールします。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> yum <span class="token function">install</span> -y mackerel-agent-plugins
</code></pre></div><p>完了したら、インストールされたプラグインを見てましょう。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">ls</span> -l /usr/bin/mackerel-plugin-*
</code></pre></div><p>50を超えるプラグインがインストールされていることを確認していただけるかと思います！</p> <p>Mackerelの公式プラグイン集は以下のGitHubリポジトリで公開されていて、OSS（オープンソースソフトウェア）なので、いつでも誰でも実装を確認できますし、修正や機能追加なども可能です。</p> <ul><li><a href="https://github.com/mackerelio/mackerel-agent-plugins" target="_blank" rel="noopener noreferrer">https://github.com/mackerelio/mackerel-agent-plugins<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>それでは数あるプラグインのうちLinuxに関するメトリック監視を拡張する<code>mackerel-plugin-linux</code>をセットアップしてみましょう。</p> <h2 id="osに関するメトリックを拡張してみる"><a href="#osに関するメトリックを拡張してみる" class="header-anchor">#</a> OSに関するメトリックを拡張してみる</h2> <p>公式プラグインパッケージに含まれている mackerel-plugin-linux プラグインを使用して、Linux OSに関するメトリックを拡張してみます。</p> <p>mackerel-agent に mackerel-plugin-linux プラグインを導入するには設定ファイル <code>/etc/mackerel-agent/mackerel-agent.conf</code> をviなどで開いて以下の2行を追記します。</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">plugin.metrics.linux</span><span class="token punctuation">]</span>
<span class="token key property">command</span> <span class="token punctuation">=</span> <span class="token string">&quot;mackerel-plugin-linux&quot;</span>
</code></pre></div><p>以下のコマンドをターミナルで実行することでも追記できます。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">sh</span> <span class="token operator">&lt;&lt;</span> <span class="token string">SCRIPT
cat &gt;&gt;/etc/mackerel-agent/mackerel-agent.conf &lt;&lt;'EOF';
[plugin.metrics.linux]
command = &quot;mackerel-plugin-linux&quot;
EOF
SCRIPT</span>
</code></pre></div><p>特にエラーなどが発生せず、再びコマンドが入力できる状態になっていれば成功です。（完了メッセージも表示されません）</p> <p>mackerel-agent.conf を変更した際に有効なシンタックスチェック機能が mackerel-agent には備わっています。次のコマンドを実行してみましょう。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>mackerel-agent configtest
</code></pre></div><p>次のような結果が出力されれば記載ミスなどがないことを確認できます。</p> <div class="language- extra-class"><pre class="language-text"><code>/etc/mackerel-agent/mackerel-agent.conf Syntax OK
</code></pre></div><p>問題なければ、以下のコマンドにより mackerel-agent を再起動します。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> systemctl restart mackerel-agent
</code></pre></div><p>コマンド実行後、<code>[ OK ]</code>と表示されていれば起動成功です。</p> <h3 id="プラグインを手動で実行してみる"><a href="#プラグインを手動で実行してみる" class="header-anchor">#</a> プラグインを手動で実行してみる</h3> <p>本来はエージェントに組み込み、エージェントが実行するプラグインですが、人の手で実行することも可能です。
以下のコマンドにより実行してみて、どのような結果が得られるか確認してみましょう。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> mackerel-plugin-linux
</code></pre></div><p>以下のような結果が表示されればプラグインが正常に実行されています。</p> <div class="language-shell extra-class"><pre class="language-shell"><code>linux.users.users	<span class="token number">1.000000</span>	<span class="token number">1620797938</span>
linux.swap.pswpin	<span class="token number">0.000000</span>	<span class="token number">1620797938</span>
linux.swap.pswpout	<span class="token number">0.000000</span>	<span class="token number">1620797938</span>
linux.ss.ESTAB	<span class="token number">89.000000</span>	<span class="token number">1620797938</span>
linux.ss.UNCONN	<span class="token number">51.000000</span>	<span class="token number">1620797938</span>
linux.ss.LISTEN	<span class="token number">42.000000</span>	<span class="token number">1620797938</span>
 <span class="token builtin class-name">:</span>
</code></pre></div><p><code>mackerel-plugin-*</code> のようなメトリックの監視を拡張するプラグインは規定のフォーマットで標準出力する仕様のため、以下の仕様に沿って実装されサーバー上で実行が可能であれば開発言語は問わず実装することが出来ます。</p> <ul><li><a href="https://mackerel.io/ja/docs/entry/advanced/custom-metrics#post-metric" target="_blank" rel="noopener noreferrer">ホストのカスタムメトリックを投稿する - Mackerel ヘルプ<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>それでは設定したプラグインのメトリックがホストに反映されているか確認してみましょう。</p> <h3 id="プラグインのメトリックを確認する"><a href="#プラグインのメトリックを確認する" class="header-anchor">#</a> プラグインのメトリックを確認する</h3> <p><a href="https://mackerel.io/my/hosts" target="_blank" rel="noopener noreferrer">Hosts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>から設定したホストの詳細画面を開いて確認してみましょう。</p> <p><img src="/mackerel-twilio-handson/assets/img/custom_metric.73207767.png" alt=""></p> <p>プラグインが取得したメトリックはカスタムメトリックとしてホストに投稿されている事が確認できました。</p> <p>Mackerelでは mackerel-agent が収集するメトリックはシステムメトリック、プラグインが収集するメトリックはカスタムメトリックとして分類されます。</p> <p>次のハンズオンではサーバーの状態を確認するチェック監視プラグインを導入してみます。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mackerel-twilio-handson/04_monitors/" class="prev">
        監視ルールを追加する
      </a></span> <span class="next"><a href="/mackerel-twilio-handson/06_check_plugins/">
        公式チェックプラグインを導入する
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/mackerel-twilio-handson/assets/js/app.e3b6fb0f.js" defer></script><script src="/mackerel-twilio-handson/assets/js/2.3f3f937c.js" defer></script><script src="/mackerel-twilio-handson/assets/js/12.818ed927.js" defer></script>
  </body>
</html>
