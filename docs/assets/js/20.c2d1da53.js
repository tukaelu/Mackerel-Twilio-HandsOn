(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{406:function(t,s,a){"use strict";a.r(s);var n=a(45),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"おまけ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#おまけ"}},[t._v("#")]),t._v(" おまけ")]),t._v(" "),a("h2",{attrs:{id:"障害を自動復旧させる"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#障害を自動復旧させる"}},[t._v("#")]),t._v(" 障害を自動復旧させる")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/06_check_plugins/"}},[t._v("『公式チェックプラグインを導入する』")]),t._v("のハンズオンで設定したチェック監視では、監視を行った結果に応じて任意のコマンドを実行する"),a("code",[t._v("action")]),t._v("オプションが用意されています。")],1),t._v(" "),a("p",[t._v("ハンズオンではhttpdプロセスの監視を実践したので、httpdプロセスのダウンを検知したらhttpdプロセスの自動復旧を行うように"),a("code",[t._v("action")]),t._v("を定義してみましょう。")]),t._v(" "),a("p",[t._v("先ほどの設定に"),a("code",[t._v("action = ...")]),t._v("の行を追加してください。")]),t._v(" "),a("div",{staticClass:"language-toml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("action")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("command")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bash -c \'[ \\"$MACKEREL_STATUS\\" != \\"OK\\" ]\' && systemctl start httpd"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("以下のように設定ができれば完了です。")]),t._v(" "),a("div",{staticClass:"language-toml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-toml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("plugin.checks.proc_httpd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("command")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"check-procs"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"--pattern"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"httpd"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("action")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key property"}},[t._v("command")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"bash -c \'[ \\"$MACKEREL_STATUS\\" != \\"OK\\" ]\' && systemctl start httpd"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[a("code",[t._v("action")]),t._v("オプションを指定すると監視が行われる度に"),a("code",[t._v("action")]),t._v("に指定された"),a("code",[t._v("command")]),t._v("が実行されます。\nその際、監視の実行結果が環境変数"),a("code",[t._v("$MACKEREL_STATUS")]),t._v("に代入されるので、"),a("code",[t._v("OK")]),t._v("以外だった場合にhttpdを起動するコマンドを実行して自動復旧させるといった仕組みになります。")]),t._v(" "),a("p",[t._v("それでは、mackerel-agentの再起動とhttpdプロセスを停止してアラートの発報から自動復旧がされるか確認してみましょう。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl restart mackerel-agent\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl stop httpd\n")])])]),a("p",[t._v("アラートが発報されたらホスト上でhttpdのプロセスが復旧していることを確認します。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" aux "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" httpd\n")])])]),a("p",[t._v("無事に復旧されているでしょうか！？")])])}),[],!1,null,null,null);s.default=e.exports}}]);